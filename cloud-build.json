{
    "steps": [{
            "name": "gcr.io/cloud-builders/docker",
            "args": [
                "build",
                "-t",
                "gcr.io/$PROJECT_ID/flask-celery-ml-app",
                "-f",
                "./Dockerfile.app",
                "."
            ]
        },
        {
            "name": "gcr.io/cloud-builders/docker",
            "args": [
                "build",
                "-t",
                "gcr.io/$PROJECT_ID/flask-celery-ml-celery",
                "-f",
                "./Dockerfile.celery",
                "."
            ]
        },
        {
            "name": "gcr.io/cloud-builders/docker",
            "args": [
                "pull",
                "redis"
            ]
        },
        {
            "name": "gcr.io/cloud-builders/docker",
            "args": [
                "push",
                "gcr.io/$PROJECT_ID/flask-celery-ml-app"
            ]
        },
        {
            "name": "gcr.io/cloud-builders/docker",
            "args": [
                "push",
                "gcr.io/$PROJECT_ID/flask-celery-ml-celery"
            ]
        },
        {
            "name": "gcr.io/cloud-builders/docker",
            "args": [
                "run",
                "-d",
                "gcr.io/$PROJECT_ID/flask-celery-ml-app"
            ]
        },
        {
            "name": "gcr.io/google.com/cloudsdktool/cloud-sdk",
            "entrypoint": "gcloud",
            "args": [
                "run",
                "deploy",
                "-port 5000",
                "-d",
                "gcr.io/$PROJECT_ID/flask-celery-ml-celery"
            ]
        },
        {
            "name": "gcr.io/google.com/cloudsdktool/cloud-sdk",
            "args": [
                "run",
                "-d",
                "-v redis_data/:data",
                "-p 6379",
                "-e CELERY_BROKER_URL=redis://redis",
                "redis"

            ]
        }
    ]
}