{
    "steps": [{
            "name": "gcr.io/cloud-builders/docker",
            "args": [
                "build",
                "-t",
                "gcr.io/$PROJECT_ID/flask-celery-ml-app",
                "-f",
                "./Dockerfile.app",
                "."
            ]
        },
        {
            "name": "gcr.io/cloud-builders/docker",
            "args": [
                "build",
                "-t",
                "gcr.io/$PROJECT_ID/flask-celery-ml-celery",
                "-f",
                "./Dockerfile.celery",
                "."
            ]
        },
        {
            "name": "gcr.io/cloud-builders/docker",
            "args": [
                "pull",
                "redis"
            ]
        },
        {
            "name": "gcr.io/cloud-builders/docker",
            "args": [
                "push",
                "gcr.io/$PROJECT_ID/flask-celery-ml-app"
            ]
        },
        {
            "name": "gcr.io/cloud-builders/docker",
            "args": [
                "push",
                "gcr.io/$PROJECT_ID/flask-celery-ml-celery"
            ]
        },
        {
            "name": "gcr.io/google.com/cloudsdktool/cloud-sdk",
            "entrypoint": "gcloud",
            "args": [
                "run",
                "deploy",
                "ml-app",
                "--image",
                "gcr.io/$PROJECT_ID/flask-celery-ml-app",
                "--port",
                "5000",
                "--region",
                "us-central1",
                "--platform",
                "managed",
                "--allow-unauthenticated"
            ]
        },
        {
            "name": "gcr.io/google.com/cloudsdktool/cloud-sdk",
            "entrypoint": "gcloud",
            "args": [
                "run",
                "deploy",
                "redis",
                "--port", 
                "6379",
                "--set-env-vars",
                "CELERY_BROKER_URL=redis://redis",
                "--image",
                "us-central1-docker.pkg.dev/redis",
                "--region",
                "us-central1",
                "--platform",
                "managed",
                "--allow-unauthenticated"
            ]
        },
        {
            "name": "gcr.io/google.com/cloudsdktool/cloud-sdk",
            "entrypoint": "gcloud",
            "args": [
                "run",
                "deploy",
                "ml-celery",
                "--image",
                "gcr.io/$PROJECT_ID/flask-celery-ml-celery",
                "--region",
                "us-central1",
                "--platform",
                "managed",
                "--allow-unauthenticated"
            ]
        }
    ]
}